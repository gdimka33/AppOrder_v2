from База_данных.БД_соединение import выполнить_запрос
from logger import logger

def _добавить_подразделение(наименование, тип_подразделения, абривиатура=None):
    try:
        тип_results = выполнить_запрос(
            "SELECT id FROM типы_подразделений WHERE наименование = ?",
            (тип_подразделения,)
        )
        if not тип_results:
            raise ValueError(f"Тип подразделения '{тип_подразделения}' не найден")
        тип_id = тип_results[0]['id']
        existing = выполнить_запрос(
            "SELECT id FROM подразделения WHERE наименование = ? AND тип_подразделения_id = ?",
            (наименование.lower(), тип_id)
        )
        if existing:
            return existing[0]['id']
        выполнить_запрос(
            """INSERT INTO подразделения (наименование, абривиатура, тип_подразделения_id) 
               VALUES (?, ?, ?)""",
            (наименование.lower(), абривиатура, тип_id)
        )
        result = выполнить_запрос("SELECT last_insert_rowid() as id")
        if not result:
            raise ValueError(f"Не удалось добавить подразделение '{наименование}'")
        return result[0]['id']
    except Exception as e:
        logger.error(f"Ошибка при добавлении подразделения {наименование}: {e}")
        raise

def _добавить_иерархию(родительское_id, дочернее_id):
    try:
        выполнить_запрос(
            """INSERT OR IGNORE INTO иерархия_подразделений 
               (родительское_подразделение_id, дочернее_подразделение_id) 
               VALUES (?, ?)""",
            (родительское_id, дочернее_id)
        )
    except Exception as e:
        logger.error(f"Ошибка при добавлении иерархии: {e}")
        raise

def заполнить_справочник_подразделений():
    try:
        руководство_id = _добавить_подразделение('Руководство института', 'Руководство', 'РИ')
        оас_id = _добавить_подразделение('Организационно-аналитическая служба', 'Служба', 'ОАС')
        ученый_совет_id = _добавить_подразделение('Ученый совет', 'Совет', 'УС')
        юр_отделение_id = _добавить_подразделение('Юридическое отделение', 'Отделение', 'ЮО')
        _добавить_иерархию(руководство_id, оас_id)
        _добавить_иерархию(оас_id, ученый_совет_id)
        _добавить_иерархию(оас_id, юр_отделение_id)
        секретариат_id = _добавить_подразделение('Секретариат', 'Секретариат', 'СЕК')
        архив_id = _добавить_подразделение('Архив', 'Отделение', 'АРХ')
        _добавить_иерархию(секретариат_id, архив_id)
        службы = [
            ('дежурная служба', 'ДС'),
            ('служба по организации мобилизационной подготовки и гражданской обороны', 'СОМП и ГО'),
            ('служба ведомственной пожарной охраны', 'СВПО'),
            ('служба связи', 'СС'),
            ('служба вооружения', 'СВ')
        ]
        for название, абр in службы:
            служба_id = _добавить_подразделение(название, 'Служба', абр)
            _добавить_иерархию(руководство_id, служба_id)
        общеинститутские_кафедры = [
            ('Кафедра боевой и тактико-специальной подготовки', 'БиТСП'),
            ('Кафедра гуманитарных и социально-экономических дисциплин', 'ГиСЭД'),
            ('Кафедра профессиональной языковой подготовки', 'ПЯП'),
            ('Кафедра психологии и педагогики профессиональной деятельности', 'ПиППД'),
            ('Кафедра специальной техники и информационных технологий', 'СТиИТ'),
        ]
        for название, абр in общеинститутские_кафедры:
            кафедра_id = _добавить_подразделение(название, 'Кафедра общеинститутская', абр)
            _добавить_иерархию(руководство_id, кафедра_id)
        юр_факультет_id = _добавить_подразделение('Юридический факультет', 'Факультет', 'ЮФ')
        _добавить_иерархию(руководство_id, юр_факультет_id)
        ооо_юф_id = _добавить_подразделение('Отделение очного обучения юридического факультета', 'Отделение', 'ООО ЮФ')
        озо_юф_id = _добавить_подразделение('Отделение заочного обучения юридического факультета', 'Отделение', 'ОЗО ЮФ')
        _добавить_иерархию(юр_факультет_id, ооо_юф_id)
        _добавить_иерархию(юр_факультет_id, озо_юф_id)
        кафедры_юр = [
            ('Кафедра государственно-правовых дисциплин юридического факультета', 'ГПД'),
            ('Кафедра гражданско-правовых дисциплин юридического факультета', 'ГрПД'),
            ('Кафедра оперативно-розыскной деятельности юридического факультета', 'ОРД'),
            ('Кафедра организации режима и надзора юридического факультета', 'ОРН'),
            ('Кафедра уголовного права и криминологии юридического факультета', 'УПК'),
            ('Кафедра уголовно-процессуального права и криминалистики юридического факультета', 'УППК'),
            ('Кафедра уголовно-исполнительного права юридического факультета', 'УИП'),
            ('Кафедра управления и административно-правовых дисциплин юридического факультета', 'УАПД'),
            ('Кафедра организации деятельности оперативных аппаратов УИС и специальных мероприятий юридического факультета', 'ОДОА'),
            ('Кафедра физической подготовки юридического факультета', 'ФП'),
            ('кафедра административно-правовых дисциплин юридического факультета', 'АДПД'),
            ('кафедра гуманитарных и социально-экономических дисциплин юридического факультета', 'ГиСЭД'),
            ('кафедра огневой и тактико-специальной подготовки юридического факультета', 'ОиТСП'),
            ('кафедра организации деятельности оперативных аппаратов уголовно-исполнительной системы и специальных мероприятий юридического факультета', 'ОДОА'),
            ('кафедра специальной техники и информационных технологий юридического факультета', 'CТиИТ'),
            ('кафедра уголовно-исполнительного права и организации исполнения наказаний, не связанных с изоляцией осужденных от общества, юридического факультета', 'УИП и ОИНО'),
            ('кафедра юридической психологии, педагогики и организации воспитательной работы с осужденными юридического факультета', 'ЮПиПО')
        ]
        for название, абр in кафедры_юр:
            кафедра_id = _добавить_подразделение(название, 'Кафедра факультетская', абр)
            _добавить_иерархию(юр_факультет_id, кафедра_id)
        усп_id = _добавить_подразделение('Учебно-строевые подразделения', 'Отдел', 'УСП')
        for i in range(1, 6):
            курс_id = _добавить_подразделение(f'{i}-й курс', 'Курс', f'К{i}')
            _добавить_иерархию(усп_id, курс_id)
        фподпо_id = _добавить_подразделение('Факультет профессионального обучения и дополнительного профессионального образования', 'Факультет', 'ФПОДПО')
        _добавить_иерархию(руководство_id, фподпо_id)
        ок_id = _добавить_подразделение('Отдел кадров', 'Отдел', 'ОК')
        _добавить_иерархию(руководство_id, ок_id)
        окпс_id = _добавить_подразделение('Отделение комплектования постоянного состава', 'Отделение', 'ОКПС')
        окпс2_id = _добавить_подразделение('Отделение комплектования переменного состава', 'Отделение', 'ОКПС')
        _добавить_иерархию(ок_id, окпс_id)
        _добавить_иерархию(ок_id, окпс2_id)
        овср_id = _добавить_подразделение('Отдел воспитательной и социальной работы с личным составом', 'Отдел', 'ОВСР')
        _добавить_иерархию(руководство_id, овср_id)
        опо_id = _добавить_подразделение('Отделение психологического обеспечения', 'Отделение', 'ОПО')
        горпк_id = _добавить_подразделение('группа организации работы по противодействию коррупции и инспекции по личному составу', 'Группа', 'ГОРПК')
        клуб_id = _добавить_подразделение('Клуб', 'Отделение', 'КЛУБ')
        _добавить_иерархию(овср_id, опо_id)
        _добавить_иерархию(овср_id, горпк_id)
        _добавить_иерархию(овср_id, клуб_id)
        пресс_служба_id = _добавить_подразделение('Пресс-служба', 'Пресс-служба', 'ПС')
        библиотека_id = _добавить_подразделение('Библиотека', 'Библиотека', 'БИБ')
        _добавить_иерархию(руководство_id, пресс_служба_id)
        _добавить_иерархию(руководство_id, библиотека_id)
        нц_id = _добавить_подразделение('Научный центр', 'Центр', 'НЦ')
        _добавить_иерархию(руководство_id, нц_id)
        оно_id = _добавить_подразделение('Организационно-научное отделение', 'Отделение', 'ОНО')
        по_id = _добавить_подразделение('Полиграфическое отделение', 'Отделение', 'ПО')
        рио_id = _добавить_подразделение('Редакционно-издательский отдел', 'Отдел', 'РИО')
        _добавить_иерархию(нц_id, оно_id)
        _добавить_иерархию(нц_id, рио_id)
        _добавить_иерархию(нц_id, по_id)
        фэо_id = _добавить_подразделение('финансово-экономический отдел', 'Отдел', 'ФЭО')
        _добавить_иерархию(руководство_id, фэо_id)
        опмоп_id = _добавить_подразделение('отделение планирования и методического обеспечения образовательного процесса', 'Отделение', 'ОПМЭП')
        _добавить_иерархию(руководство_id, опмоп_id)
        оумц_id = _добавить_подразделение('отделение по учету материальных ценностей', 'Отделение', 'ОУМЦ')
        _добавить_иерархию(фэо_id, оумц_id)
        уо_id = _добавить_подразделение('учебный отдел', 'Отдел', 'УО')
        _добавить_иерархию(руководство_id, уо_id)
        рс_id = _добавить_подразделение('расчетное отделение', 'Отделение', 'РС')
        _добавить_иерархию(уо_id, рс_id)
        омккоп_id = _добавить_подразделение('отдел менеджмента и контроля качества образовательного процесса', 'Отдел', 'ОМККОП')
        _добавить_иерархию(руководство_id, омккоп_id)
        овтсо_id = _добавить_подразделение('отдел по внедрению и использованию технических средств обучения', 'Отдел', 'ОВТСО')
        _добавить_иерархию(руководство_id, овтсо_id)
        гкс_id = _добавить_подразделение('группа капитального строительства', 'Группа', 'ГКС')
        _добавить_иерархию(руководство_id, гкс_id)
        ото_id = _добавить_подразделение('Отдел тылового обеспечения', 'Отдел', 'ОТО')
        _добавить_иерархию(руководство_id, ото_id)
        тыловые_подразделения = [
            ('Служба государственного оборонного заказа и государственных закупок', 'СГОЗ'),
            ('Квартирно-эксплуатационное отделение', 'КЭО'),
            ('Служба вещевого обеспечения', 'СВО'),
            ('Отделение продовольственного обеспечения', 'ОПО'),
            ('Отделение автомобильного транспорта', 'ОАТ')
        ]
        for название, абр in тыловые_подразделения:
            подр_id = _добавить_подразделение(название, 'Отделение', абр)
            _добавить_иерархию(ото_id, подр_id)
        фпу_id = _добавить_подразделение('Факультет права и управления', 'Факультет', 'ФПУ')
        _добавить_иерархию(руководство_id, фпу_id)
        кафедры_фпу = [
            ('Кафедра теории и истории государства и права', 'ТИГП'),
            ('Кафедра публично-правовых дисциплин', 'ППД'),
            ('Кафедра частноправовых дисциплин', 'ЧПД'),
            ('Кафедра управления и информационных технологий', 'УИТ')
        ]
        for название, абр in кафедры_фпу:
            кафедра_id = _добавить_подразделение(название, 'Кафедра факультетская', абр)
            _добавить_иерархию(фпу_id, кафедра_id)
        озгт_id = _добавить_подразделение('Отдел по защите государственной тайны', 'Отдел', 'ОЗГТ')
        _добавить_иерархию(руководство_id, озгт_id)
        гтзи_id = _добавить_подразделение('Группа технической защиты информации', 'Группа', 'ГТЗИ')
        сб_id = _добавить_подразделение('Секретная библиотека', 'Библиотека', 'СБ')
        _добавить_иерархию(озгт_id, гтзи_id)
        _добавить_иерархию(озгт_id, сб_id)
        _добавить_подразделение('Филиал МЧ-3 ФКУЗ МСЧ-33 ФСИН России', 'Филиал', 'МЧ-3')
        logger.info("Справочник подразделений успешно заполнен")
    except Exception as e:
        logger.error(f"Ошибка при заполнении справочника подразделений: {e}")
        raise
